# 工具函数

<cite>
**本文档引用的文件**
- [env.ts](file://frontend/src/main/utils/env.ts)
- [file.ts](file://frontend/src/main/utils/file.ts)
- [time.ts](file://frontend/src/main/utils/time.ts)
- [get-capture-sources.ts](file://frontend/src/main/utils/get-capture-sources.ts)
- [mac-window-manager.ts](file://frontend/src/main/utils/mac-window-manager.ts)
- [index.ts](file://frontend/src/main/utils/index.ts)
</cite>

## 目录
1. [简介](#简介)
2. [环境变量管理](#环境变量管理)
3. [文件系统操作](#文件系统操作)
4. [时间处理与格式化](#时间处理与格式化)
5. [屏幕与窗口捕获源枚举](#屏幕与窗口捕获源枚举)
6. [macOS窗口管理](#macos窗口管理)
7. [工具函数复用与可维护性](#工具函数复用与可维护性)
8. [代码示例](#代码示例)

## 简介
本项目主进程中`utils`目录下的工具函数为整个应用提供了基础支持。这些函数被多个上层服务和模块广泛复用，确保了代码的可维护性和一致性。核心工具包括环境变量管理、文件系统操作、时间处理、屏幕捕获源枚举以及针对macOS平台的窗口管理功能。

**Section sources**
- [env.ts](file://frontend/src/main/utils/env.ts)
- [file.ts](file://frontend/src/main/utils/file.ts)
- [time.ts](file://frontend/src/main/utils/time.ts)
- [get-capture-sources.ts](file://frontend/src/main/utils/get-capture-sources.ts)
- [mac-window-manager.ts](file://frontend/src/main/utils/mac-window-manager.ts)

## 环境变量管理
`env.ts`文件负责管理应用的运行环境配置。它通过`app.isPackaged`判断应用是否处于打包后的生产环境，并据此动态确定资源路径。在开发环境下，资源路径指向前端目录下的后端目录；在生产环境下，则使用`process.resourcesPath`指向打包后的资源目录。此外，该文件还定义了`serverRunInFrontend`等标志位，用于控制Python服务器的运行模式。

**Section sources**
- [env.ts](file://frontend/src/main/utils/env.ts#L1-L30)

## 文件系统操作
`file.ts`提供了丰富的文件系统操作工具。它包含路径解析函数（如`untildify`用于处理`~`符号）、权限检查（`hasWritePermission`）、路径关系判断（`isPathInside`用于安全地检查父子路径关系）以及文件类型识别。该模块还封装了读取文本文件并自动检测编码的功能，通过`chardet`库检测文件编码，并使用`iconv-lite`进行解码，确保能正确处理不同编码格式的文件。此外，它还定义了获取应用特定目录（如用户数据目录、缓存目录、配置目录）的函数。

**Section sources**
- [file.ts](file://frontend/src/main/utils/file.ts#L1-L200)

## 时间处理与格式化
`time.ts`利用`dayjs`库提供了时间处理和格式化工具。主要功能包括将日期转换为SQLite存储所需的UTC时间格式（`toSqliteDatetime`），从SQLite读取时间并转换为本地时区（`fromSqliteDatetime`），以及验证ISO格式字符串的有效性（`isValidIsoString`）。这些函数确保了应用在不同平台和时区下时间数据的一致性和正确性。

**Section sources**
- [time.ts](file://frontend/src/main/utils/time.ts#L1-L23)

## 屏幕与窗口捕获源枚举
`get-capture-sources.ts`是屏幕捕获功能的核心。它通过Electron的`desktopCapturer`获取当前可见的屏幕和窗口列表，并结合macOS平台特有的`mac-window-manager`模块，能够枚举出跨桌面空间和最小化的窗口。该模块定义了统一的`CaptureSource`接口，包含ID、名称、类型、缩略图、应用图标和可见性等属性。对于Electron原生API无法捕获的窗口，它会创建“虚拟”捕获源，并尝试通过Python脚本或原生模块获取其截图，从而提供更完整的捕获选项。

**Section sources**
- [get-capture-sources.ts](file://frontend/src/main/utils/get-capture-sources.ts#L1-L775)

## macOS窗口管理
`mac-window-manager.ts`专门针对macOS平台，利用Python脚本和Quartz框架获取系统中所有窗口的详细信息，包括窗口ID、应用名称、标题、位置、大小、层级和是否在屏幕上等。它通过`getAllWindows`函数返回一个`FinalWindowInfo`数组，该函数会过滤掉系统进程，并对重要应用（如Zoom、Teams、Chrome等）进行特殊处理，即使它们被最小化或位于其他桌面空间也能被正确识别。这些信息被`get-capture-sources.ts`用来补充Electron原生API的不足。

**Section sources**
- [mac-window-manager.ts](file://frontend/src/main/utils/mac-window-manager.ts#L1-L187)

## 工具函数复用与可维护性
这些工具函数被上层服务和模块广泛复用，极大地提高了代码的可维护性。例如，`FileService`和`ScreenshotService`都依赖`file.ts`中的`getFilesDir`来确定文件存储路径；`DatabaseService`使用`time.ts`中的`toSqliteDatetime`和`isValidIsoString`来处理时间数据；`ScreenshotService`直接导入并使用`get-capture-sources.ts`中的`CaptureSourcesTools`类来管理捕获源。通过将这些通用功能抽象为独立的工具模块，避免了代码重复，使得功能变更或修复只需在单一位置进行，降低了维护成本和引入bug的风险。

**Section sources**
- [index.ts](file://frontend/src/main/utils/index.ts#L1-L72)
- [FileService.ts](file://frontend/src/main/services/FileService.ts)
- [ScreenshotService.ts](file://frontend/src/main/services/ScreenshotService.ts)
- [DatabaseService.ts](file://frontend/src/main/services/DatabaseService.ts)

## 代码示例
以下代码示例展示了如何在实际场景中调用这些工具函数：

1.  **获取资源路径**：在`backend.ts`中，通过导入`env.ts`的`getResourcesPath`函数来确定Python服务器的可执行文件路径。
2.  **检查文件写入权限**：在`ipc.ts`中，使用`file.ts`的`hasWritePermission`函数来验证用户选择的目录是否具有写入权限。
3.  **格式化时间**：在前端组件中，如`recording-timeline.tsx`，通过`@renderer/utils/time`导入`formatTime`函数，将时间戳格式化为用户友好的显示格式。
4.  **枚举捕获源**：在`ScreenshotService.ts`中，创建`CaptureSourcesTools`实例，并调用其`getCaptureSourcesTools`方法来获取所有可用的屏幕和窗口捕获源，用于在UI中展示给用户选择。

这些示例体现了工具函数在不同层级间的调用方式，从主进程的服务到渲染进程的UI组件，均能方便地访问这些基础功能。

**Section sources**
- [backend.ts](file://frontend/src/main/backend.ts#L10)
- [ipc.ts](file://frontend/src/main/ipc.ts#L31)
- [recording-timeline.tsx](file://frontend/src/renderer/src/pages/screen-monitor/components/recording-timeline.tsx#L4)
- [ScreenshotService.ts](file://frontend/src/main/services/ScreenshotService.ts#L9)